rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
  
    // --- Helper Functions ---

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Checks if the user is the 'hostId' listed on the resource
    function isResourceHost() {
       return isAuthenticated() && resource.data.hostId == request.auth.uid;
    }
    
    // Checks if the user is the 'hostId' of the PARENT class
    function isClassHost(classId) {
      return isAuthenticated() && get(/databases/$(database)/documents/classes/$(classId)).data.hostId == request.auth.uid;
    }

    // --- Collection Rules ---

    // USERS
    // Public read needed for leaderboards (to see names/photos)
    // Write STRICTLY limited to the user themselves
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if false; // Users cannot delete themselves via client SDK for safety
      
      // Redemption History (Private to user)
      match /redemptions/{redemptionId} {
        allow read: if isOwner(userId);
        // Only allow creation if the user IDs match (logic handled in functions/client)
        allow write: if isOwner(userId); 
      }
    }

    // CLASSES
    match /classes/{classId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      
      // Update: Host has full control. 
      // Students can ONLY update 'memberIds' to join/leave.
      allow update: if isAuthenticated() && (
        resource.data.hostId == request.auth.uid || 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['memberIds'])
      );
      
      // Delete: Only Host
      allow delete: if isAuthenticated() && resource.data.hostId == request.auth.uid;

      // Sub: MEMBERS
      match /members/{memberId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        // Update: Member can update their own data; Host can update anyone
        allow update: if isAuthenticated() && (
          request.auth.uid == memberId || 
          isClassHost(classId)
        );
        allow delete: if isAuthenticated() && (request.auth.uid == memberId || isClassHost(classId));
        
        match /history/{historyId} {
            allow read, write: if isAuthenticated() && (request.auth.uid == memberId || isClassHost(classId));
        }
      }
      
      // Sub: ENERGY
      match /energy/{userId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() && request.auth.uid == userId;
      }
      
      // Sub: PULSE CHECKS
      match /pulseChecks/{pulseId} {
        allow read: if isAuthenticated();
        allow write: if isClassHost(classId);
      }
      
      // Sub: TOOLS (Buzzer, etc.)
      match /tools/{toolId} {
        allow read: if isAuthenticated();
        
        // Update: Host full; Student can only buzz (cannot change config/status)
        allow update: if isAuthenticated() && (
          isClassHost(classId) ||
          (toolId == 'buzzer' && request.resource.data.status == resource.data.status)
        );
        
        allow create, delete: if isClassHost(classId);
      }

      // Sub: COMMITMENTS
      match /commitments/{commitmentId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow delete: if isClassHost(classId); // Only host can moderate/delete
      }
    }

    // LEADER GRID CODES (QR Codes)
    match /leader_grid_codes/{codeId} {
      allow read: if isAuthenticated(); // Students need to read to validate code
      
      // Only Host can create/manage codes
      allow create: if isAuthenticated() && request.resource.data.hostId == request.auth.uid;
      allow update, delete: if isResourceHost(); // Only the host who created it

      match /redemptions/{userId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() && request.auth.uid == userId;
      }
    }

    // QUIZZES (Library)
    match /quizzes/{quizId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.createdBy == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
    }

    // POLLS
    match /polls/{pollId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isResourceHost();
      
      match /votes/{voteId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated(); // Students vote
      }
    }
    
    // WORDSTORMS
    match /wordstorms/{stormId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      
      // Only Host can archive/update the storm settings
      allow update, delete: if isResourceHost();
      
      match /words/{wordId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated(); // Students submit words
        allow delete: if isAuthenticated() && (
            resource.data.userId == request.auth.uid || 
            get(/databases/$(database)/documents/wordstorms/$(stormId)).data.hostId == request.auth.uid
        );
      }
    }

    // PICPICK GALLERIES
    match /galleries/{galleryId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isResourceHost();
      
      match /photos/{photoId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        
        allow update: if isAuthenticated() && (
           // Host manages (approve/reject)
           get(/databases/$(database)/documents/galleries/$(galleryId)).data.hostId == request.auth.uid || 
           (
             // Students Vote: Only 'votes' field, increment by 1
             request.resource.data.diff(resource.data).affectedKeys().hasOnly(['votes']) &&
             request.resource.data.votes == resource.data.votes + 1
           )
        );
        
        allow delete: if isAuthenticated() && (
          request.auth.uid == resource.data.userId || 
          get(/databases/$(database)/documents/galleries/$(galleryId)).data.hostId == request.auth.uid
        );
      }
    }

    // PARKING LOT
    match /parking_lot/{questionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      
      // Host answers (updates)
      allow update: if isAuthenticated() && 
        get(/databases/$(database)/documents/classes/$(resource.data.classId)).data.hostId == request.auth.uid;
        
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        get(/databases/$(database)/documents/classes/$(resource.data.classId)).data.hostId == request.auth.uid
      );
    }
    
    // ANALYTICS (Strict)
    match /analytics_events/{eventId} {
      allow create: if isAuthenticated(); // All activities/users log events
      // Read: RESTRICTED. 
      // Only the Host of the class or the User who triggered it can read details if needed.
      // For Super Admin Dashboard to work, we'd typically use the Admin SDK (server-side).
      // If the client needs to read stats, we only allow reading your own class's events.
      allow read: if isAuthenticated() && (
         resource.data.userId == request.auth.uid ||
         (resource.data.classId != null && get(/databases/$(database)/documents/classes/$(resource.data.classId)).data.hostId == request.auth.uid)
      );
    }
  }
}
